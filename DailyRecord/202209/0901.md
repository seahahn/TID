# 20220901

1. API ì„œë²„ ê³¼ë¶€í•˜ í…ŒìŠ¤íŠ¸

- nestjsë¡œ êµ¬ì¶•í•œ API ì„œë²„ì˜ ê³¼ë¶€í•˜ í…ŒìŠ¤íŠ¸ë¥¼ í•˜ê³ ì í•¨
- ì—¬ëŸ¬ ê°€ì§€ ë¶€í•˜ í…ŒìŠ¤íŠ¸ ë„êµ¬ê°€ ìˆì—ˆê³ , ê·¸ ì¤‘ì—ì„œ nodejs ê¸°ë°˜ì˜ Artilleryë¥¼ ì‚¬ìš©í•´ë´„
  - ê°„ë‹¨í•˜ê²Œ npmì„ í†µí•´ ì„¤ì¹˜ ê°€ëŠ¥í–ˆê³ , yaml ë˜ëŠ” json í˜•ì‹ìœ¼ë¡œ ì‹œë‚˜ë¦¬ì˜¤ ì„¤ì •ì´ ê°€ëŠ¥í•œ ë“±ì˜ ê°„í¸í•¨ì´ ì¥ì 
  - ê°€ìƒ ì‚¬ìš©ì ìˆ˜, ìš”ì²­ íšŸìˆ˜ ë“±ì˜ í…ŒìŠ¤íŠ¸ ì˜µì…˜ ì„¤ì •ë„ ê°„ë‹¨í–ˆìŒ
- ì ìš© ë° í…ŒìŠ¤íŠ¸ ê³¼ì •ì€ ì•„ë˜ì™€ ê°™ìŒ

  ```
  // ì•„ì˜ˆ í…ŒìŠ¤íŠ¸ ëŒ€ìƒ í”„ë¡œì íŠ¸ë³„ ì„¤ì • íŒŒì¼ ë“±ì„ ì €ì¥í•˜ê¸° ìœ„í•´ ë³„ë„ë¡œ í”„ë¡œì íŠ¸ë¥¼ ë§Œë“  í›„ ì—¬ê¸°ì— íŒ¨í‚¤ì§€ ì„¤ì¹˜í•¨
  // global ì˜µì…˜ì„ í†µí•´ ì „ì—­ ì„¤ì¹˜í•´ë„ ë¬´ê´€
  pnpm add -D artillery

  // ê°€ì¥ ê°„ë‹¨í•˜ê²Œ í…ŒìŠ¤íŠ¸í•˜ë ¤ë©´ ì•„ë˜ì™€ ê°™ì´ ê°€ëŠ¥
  // count: ê°€ìƒ ì‚¬ìš©ì ìˆ˜ / n: ìš”ì²­ íšŸìˆ˜
  npx artillery quick --count 100 -n 50 http://localhost:3001
  ```

- ì‹¤ì œë¡œëŠ” ì•„ë˜ì™€ ê°™ì€ ì‹œë‚˜ë¦¬ì˜¤ ì„¤ì •ì„ í†µí•´ í…ŒìŠ¤íŠ¸ë¥¼ í•˜ëŠ” ê²½ìš°ê°€ ë§ì„ ê²ƒì„

  ```yml
  config:
    target: "https://example.com/api"
    phases:
      # durationì´ˆ ë™ì•ˆ ë§¤ì´ˆë§ˆë‹¤ arrivalRateëª…ì˜ ê°€ìƒ ì‚¬ìš©ì ìš”ì²­ì„ ë³´ëƒ„
      - duration: 3 # seconds
        arrivalRate: 5 # virtual users per second
        name: Warm up
      # # arrivalRateëª…ì˜ ê°€ìƒ ì‚¬ìš©ìë¶€í„° ì‹œì‘í•˜ì—¬ durationì´ˆì— ê±¸ì³ ì ì§„ì ìœ¼ë¡œ ìµœëŒ€ rampToëª…ì˜ ê°€ìƒ ì‚¬ìš©ì ìš”ì²­ì„ ë³´ëƒ„
      - duration: 5
        arrivalRate: 5
        rampTo: 50 # max users
        name: Ramp up load
      # # durationì´ˆ ê°„ ë§¤ ì´ˆë§ˆë‹¤ arrivalRateëª…ì˜ ê°€ìƒ ì‚¬ìš©ì ìš”ì²­ì„ ë³´ëƒ„
      - duration: 10
        arrivalRate: 10
        name: Sustained load
    # í…ŒìŠ¤íŠ¸ í™˜ê²½ì„ ë³„ë„ë¡œ ì§€ì • ê°€ëŠ¥
    # ì•„ë˜ì˜ ê²½ìš° ì²« ë²ˆì§¸ phaseëŠ” environmentì— ì„¤ì •í•œ ëŒ€ë¡œ ìˆ˜í–‰í•˜ê³ , ë‘ ë²ˆì§¸ë¶€í„°ëŠ” ìœ„ì—ì„œ ì„¤ì •í•œ ê¸°ë³¸ phasesë¥¼ ë”°ë¼ê°
    # ê° environments ì•„ë˜ì— ì¶”ê°€ë¡œ ë‘ ë²ˆì§¸, ì„¸ ë²ˆì§¸, ... phases ì„¤ì •í•´ì£¼ë©´ ì´ëŒ€ë¡œ ìˆ˜í–‰í•¨
    environments:
      local:
        target: "http://localhost:3001"
        phases:
          - duration: 5
            arrivalRate: 1
            name: Dev Warm up
      development:
        target: "https://example-test.com/api"
        phases:
          - duration: 60
            arrivalRate: 5
            name: Test Warm up
    # í…ŒìŠ¤íŠ¸ì— ì‚¬ìš©í•  CSV íŒŒì¼ ê°€ì ¸ì˜¤ê¸°
    # CSV íŒŒì¼ì˜ í•œ rowë§ˆë‹¤ í•˜ë‚˜ì˜ ê°€ìƒ ì‚¬ìš©ìê°€ ì‚¬ìš©í•¨(ì•„ë˜ loadAllì´ falseì¼ ë•Œë§Œ)
    # ì£¼ì˜ì‚¬í•­: CSV íŒŒì¼ ë§Œë“¤ ë•Œ ì»¬ëŸ¼ëª…ê³¼ ì‰¼í‘œ ì‚¬ì´ì— ë„ì–´ì“°ê¸° ë„£ì§€ ë§ ê²ƒ(ë„ì–´ì“°ê¸° í¬í•¨í•´ì„œ ì¸ì‹í•¨)
    payload:
      - path: "result_share_{{ $environment }}.csv" # CSV íŒŒì¼ ìƒëŒ€ ê²½ë¡œ
        skipHeader: true # CSV íŒŒì¼ì˜ ì²« rowë¥¼ skipí• ì§€ ì—¬ë¶€
        order: random # CSV íŒŒì¼ì˜ rowë¥¼ ì„ì˜ë¡œ ì„ì„ì§€ ì—¬ë¶€. ìˆœì„œëŒ€ë¡œ í• ê±°ë©´ sequenceë¡œ ì§€ì •.
        fields:
          # í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ ì•ˆì—ì„œ ì‚¬ìš©í•  ë³€ìˆ˜ëª…
          # CSV íŒŒì¼ì˜ ì»¬ëŸ¼ëª…ì´ë¼ ìƒê°í•˜ë©´ ë¨
          - "user_id"
          - "record_id"
        loadAll: false # trueì¼ ê²½ìš° ê°ê°ì˜ ê°€ìƒ ì‚¬ìš©ìê°€ CSV íŒŒì¼ ì „ì²´ì— ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ë§Œë“¦
        # name: userinfo # refer to the data as "userinfo" -> loadAll: trueì¼ ë–„ ì‚¬ìš©
      # ì—¬ëŸ¬ CSV íŒŒì¼ì„ ê°€ì ¸ì˜¤ê¸° ê°€ëŠ¥
      - path: "share_dates.csv"
        skipHeader: true
        fields:
          - "start"
          - "end"
  # ì‹œë‚˜ë¦¬ì˜¤ ì‹¤í–‰ ì „ì— ìˆ˜í–‰ë˜ëŠ” ë¶€ë¶„
  # ì—¬ê¸°ì„œ ë°›ì€ responseì— í¬í•¨ëœ ë³€ìˆ˜ë“¤ì€ ì‹œë‚˜ë¦¬ì˜¤ ì „ì²´ì—ì„œ ì‚¬ìš© ê°€ëŠ¥
  before:
    flow:
      # - log: "Get auth token"
      # - post:
      #     url: "/auth/users/signin"
      #     json:
      #       email: "{{ $processEnvironment.TEST_USER_EMAIL }}"
      #       password: "{{ $processEnvironment.TEST_USER_PW }}"
      #     capture:
      #       - json: $.accessToken
      #         as: accessToken
      #       - json: $.refreshToken
      #         as: refreshToken
      #       - json: $.idToken
      #         as: idToken
      - log: "Get CSV File from {{ $environment }}"
      - log: "Check CSV File - result_share: {{ user_id }}, {{ record_id }}"
      - log: "Check CSV File - share_dates: {{ start }}, {{ end }}"
      - log: "Get User Info"
      - get:
          url: "/guest/users/info/{{ user_id }}"
          # headers:
          #     authorization: "Bearer {{ accessToken }}"
  scenarios:
    - name: "Personal Record Sharing" # í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ ì´ë¦„
      flow:
        - log: "Share Record: {{ start }}, {{ end }}"
        - get:
            url: "/guest/records/{{ user_id }}/{{ record_id }}"
        - get:
            url: "/guest/records/{{ user_id }}/company/average"
            qs: # query string
              start: "{{ start }}"
              end: "{{ end }}"
        - get:
            url: "/guest/records/{{ user_id }}/emission/sum"
            qs:
              start: "{{ start }}"
              end: "{{ end }}"
        # - loop:
        #     - get:
        #         url: "/guest/users/info/{{ $loopElement.user_id }}" # CSV íŒŒì¼ ë‚´ ì „ì²´ rowë¥¼ ìˆœíšŒí•˜ë©° ë³€ìˆ˜ë¥¼ ê°€ì ¸ì˜´
        #   over: userinfo # payloadì—ì„œ ì§€ì •í•œ nameì„ ì°¸ì¡°
  ```

- ìœ„ì™€ ê°™ì€ ì‹œë‚˜ë¦¬ì˜¤ ì„¤ì • íŒŒì¼ ìƒì„± í›„ í„°ë¯¸ë„ì—ì„œ í•´ë‹¹ íŒŒì¼ ìœ„ì¹˜ë¡œ ì´ë™ í›„ ì•„ë˜ ëª…ë ¹ì„ ì‹¤í–‰í•˜ë©´ í…ŒìŠ¤íŠ¸ê°€ ì‹œì‘ë¨
  ```
  // -e ë’¤ì—ëŠ” environments ì—ì„œ ì„¤ì •í•œ í™˜ê²½ ì´ë¦„ ì¤‘ í•˜ë‚˜ë¥¼ ì§€ì •í•˜ë©´ ë¨
  npx artillery run -e dev stress-test.yml
  ```
- í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë³´ê³ ì„œë¥¼ ìƒì„±í•˜ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ëª…ë ¹ì„ ì‹¤í–‰í•˜ë©´ ë¨
  ```
  // ì´ ëª…ë ¹ì„ ìˆ˜í–‰í•˜ë©´ test-result ë¼ëŠ” ì´ë¦„ì˜ íŒŒì¼ì´ ìƒì„±ë˜ê³ , ì´ë¥¼ html íŒŒì¼ë¡œ ë³€í™˜í•¨
  npx artillery run -o test-result stress-test.yml && npx artillery report test-result
  ```

<ì°¸ê³  ìë£Œ>

- [Ubuntu CPU Monitor](https://linuxhint.com/ubuntu_cpu_monitor/)
- [How Do I Find Out Linux CPU Utilization and Usage?](https://www.cyberciti.biz/tips/how-do-i-find-out-linux-cpu-utilization.html)
- [Runtime options with Memory, CPUs, and GPUs - docker docs](https://docs.docker.com/config/containers/resource_constraints/)
- [Start containers automatically - docker docs](https://docs.docker.com/config/containers/start-containers-automatically/)
- [Test Scripts - Artillery Docs](https://www.artillery.io/docs/guides/guides/test-script-reference)
- [[Artillery] ğŸ“š ë¶€í•˜ í…ŒìŠ¤íŠ¸ (Stress Test) í•˜ëŠ”ë²•](https://inpa.tistory.com/entry/JEST-%F0%9F%93%9A-%EB%B6%80%ED%95%98-%ED%85%8C%EC%8A%A4%ED%8A%B8-Stress-Test)
