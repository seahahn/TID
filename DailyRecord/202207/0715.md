# 20220715

1. from Yarn berry to pnpm

- í”„ë¡œì íŠ¸ íŒ¨í‚¤ì§€ ë§¤ë‹ˆì €ë¥¼ ì²˜ìŒì— yarn berryë¡œ ì„¤ì •í–ˆìŒ
- ê·¸ëŸ°ë° test ì„¸íŒ…ì„ í•˜ë ¤ë‹ˆ jestê°€ node_modulesì— ìˆëŠ” íŒŒì¼ì„ ì½ì–´ì•¼ í•œë‹¤ë©´ì„œ ì—ëŸ¬ê°€ ë°œìƒí•¨
- ì‚¬ì‹¤ ì´ì „ì—ë„ ì¢€ ì„¸íŒ…ì´ ë²ˆê±°ë¡œì› ê³ , ì´í›„ì—ë„ ë¹„ìŠ·í•œ ê²½ìš°ê°€ ë‹¤ìˆ˜ ë°œìƒí•  ê²ƒì´ë¼ëŠ” ìš°ë ¤ê°€ ìƒê²¼ìŒ
- ë”°ë¼ì„œ pnpmìœ¼ë¡œ ì „í™˜í•¨
- ì „í™˜ ìˆœì„œ
  - .yarn, .yarnrc.yml ë“± yarn berry ê´€ë ¨ ë””ë ‰í† ë¦¬ ë° íŒŒì¼ ì‚­ì œ
  - package.json ì— "packageManager": "pnpm@7.5.1" í•­ëª© ì¶”ê°€(ë²„ì „ì€ ë‹¹ì‹œ ìµœì‹  ë²„ì „)
  - pnpm install

---

2. Nest.js Testing with @nestjs/testing (fest. Jest)

- ë°±ì•¤ë“œ ìª½ì—ë„ í…ŒìŠ¤íŠ¸ë¥¼ ë°˜ì˜í•˜ê¸° ìœ„í•œ ë°©ë²•ì„ ì°¾ì•„ë³´ë‹ˆ @nestjs/testingì´ë¼ëŠ” ë‚´ì¥ëœ íŒ¨í‚¤ì§€ê°€ ìˆì—ˆìŒ
- ì´ë¥¼ ë°”íƒ•ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ ì„¸íŒ…ì„ í•¨
- ìˆœì„œëŠ” ì•„ë˜ì™€ ê°™ìŒ

```
// í…ŒìŠ¤íŒ… íŒ¨í‚¤ì§€ ì„¤ì¹˜
pnpm add -D @nest/testing
```

```ts
// jest.config.ts
// í…ŒìŠ¤íŠ¸ ê¸°ë³¸ ì„¤ì • íŒŒì¼ ì‘ì„±
import type { Config } from "@jest/types";

const config: Config.InitialOptions = {
  moduleDirectories: ["node_modules", "src"],
  moduleFileExtensions: ["js", "json", "ts"],
  roots: ["src", "test"],
  setupFiles: ["<rootDir>/.jest/setEnvVars.ts"],
  testRegex: ".*\\.spec\\.ts$",
  transform: {
    "^.+\\.(t|j)s$": "ts-jest",
  },
  collectCoverageFrom: ["**/*.(t|j)s"],
  coverageDirectory: "../coverage",
  testEnvironment: "node",
  moduleNameMapper: {
    "src/(.*)": "<rootDir>/src/$1",
  },
};
export default config;
```

```ts
// jest-e2e.config.ts
// E2E í…ŒìŠ¤íŠ¸ì˜ ê²½ìš° íŒŒì¼ëª… í˜•ì‹ë§Œ ë‹¤ë¥´ê²Œ í•´ì¤Œ
import type { Config } from "@jest/types";
import sharedConfig from "./jest.config";

const config: Config.InitialOptions = {
  ...sharedConfig,
  testRegex: ".e2e-spec.ts$",
};
export default config;
```

```ts
// ìœ ë‹› í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„±
// íŒŒì¼ëª…ì€ ~~~.spec.ts ë˜ëŠ” ~~~.test.ts í˜•ì‹ìœ¼ë¡œ í•¨
import {Test} from "@nestjs/testing";
import {DatabaseUserRepository} from "src/infrastructure/database/repositories/user.repository";
import {TypeOrmConfigModule} from "src/infrastructure/config/typeorm/typeorm.module";
import {TypeOrmModule} from "@nestjs/typeorm";
import {UserModel} from "src/domain/models/user.model";
import {User} from "src/infrastructure/database/entities/user.entity";
import {UserRole} from "src/domain/enums/user_role.enum";
import {Repository} from "typeorm";

describe("Example Repository Test", () => {
  let userRepository: DatabaseUserRepository;
  let userEntityRepository: Repository<User>;

  beforeEach(async () => {
    const moduleRef = await Test.createTestingModule({
      imports: [TypeOrmConfigModule, TypeOrmModule.forFeature([User])], // í•„ìš”í•œ ëª¨ë“ˆ import
      controllers: [],
      providers: [DatabaseUserRepository, Repository], // í…ŒìŠ¤íŠ¸í•  ë ˆí¬ì§€í† ë¦¬ ì§€ì •
    }).compile();

    userEntityRepository = moduleRef.get<Repository<User>>(Repository<User>);
    userRepository = new DatabaseUserRepository(userEntityRepository); // ìƒì„±ìì— ë§ê²Œ ì£¼ì…
  });

  describe("DatabaseUserRepository", () => {
    const id = process.env.TEST_USER_ID;
    it("should return the user info", async () => {
      const result = {
        email: "test@test.com",
        role: "user",
        userName: "ì´ë¯¼",
        company: "íƒ„ì†Œì¤‘ë¦½ì—°êµ¬ì›",
        jobTitle: "ëŒ€í‘œ",
        phoneNumber: "010-1111-1111",
      };
      // DB ì ‘ê·¼ mocking
      const spyRepo = jest.spyOn(userEntityRepository, "findOneOrFail").mockResolvedValue({
        id,
        consent: true,
        sso_id: "d9797d3b-7d66-420e-9f1d-f849bcd5ed41",
        role: UserRole.USER_ROLE,
        email: "test@test.com",
        user_name: result.userName,
        company: result.company,
        job_title: result.jobTitle,
        phone_number: result.phoneNumber,
        created_at: new Date(),
        updated_at: new Date(),
      } as User);

      const resultUser = await userRepository.findById(id);
      expect(spyRepo).toBeCalled(); // mockingí•œ í•¨ìˆ˜ê°€ í˜¸ì¶œë˜ì—ˆëŠ”ì§€ í™•ì¸
      expect(resultUser).toBeInstanceOf(UserModel);
      expect(resultUser).toMatchObject(result);
    });
  });
});
```

```ts
// E2E í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„±
import * as request from "supertest";
import { Test } from "@nestjs/testing";
import { INestApplication } from "@nestjs/common";
import { AppModule } from "src/app.module";

describe("AppController (e2e)", () => {
  let app: INestApplication;

  beforeAll(async () => {
    const moduleRef = await Test.createTestingModule({
      imports: [AppModule],
    }).compile();

    app = moduleRef.createNestApplication();
    await app.init();
  });

  it(`/POST signIn`, () => {
    const email = process.env.TEST_USER_EMAIL;
    const pw = process.env.TEST_USER_PW;

    return request(app.getHttpServer())
      .post("/auth/users/signin") // methodì™€ url ì§€ì •
      .send({
        email,
        password: pw,
      }) // POSTì´ë¯€ë¡œ body ì§€ì •
      .expect(201) // ì˜ˆìƒ statusCode ì§€ì •
      .then((res) => {
        expect(res.body.expires_in).toBe(300);
      });
  });

  afterAll(async () => {
    await app.close();
  });
});
```

```yml
# Github Actions Workflow ì‘ì„±
name: Unit & E2E Test
on:
  push:
    branches: [main, develop]
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop]
concurrency:
  # https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#concurrency
  # head_ref: ë™ì¼ PRì´ë©´ ì´ì „ì— ì‹¤í–‰ëœ workflow ì·¨ì†Œ
  # ref: ë™ì¼í•œ branchì´ë©´ ì´ì „ì— ì‹¤í–‰ëœ workflow ì·¨ì†Œ
  # run_id: ì•ì˜ ë‘ ê²½ìš° ëª¨ë‘ì— í•´ë‹¹ ì—†ìœ¼ë©´ ì‹¤í–‰ë¨
  group: ${{ github.head_ref || github.ref || github.run_id }}
  cancel-in-progress: true
jobs:
  # ì›¹ ì„œë²„ ì‹¤í–‰ì„ ìœ„í•œ ì¡°ê±´ì„ ê°–ì¶˜ í›„ build ì‹¤í–‰
  # build í›„ì— í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ í›„ í…ŒìŠ¤íŠ¸ ì§„í–‰
  # í…ŒìŠ¤íŠ¸ë¥¼ í†µê³¼í•˜ë©´ Vercelë¡œ ë°°í¬ ì§„í–‰
  build:
    timeout-minutes: 5
    runs-on: ubuntu-latest # self-hosted || ubuntu-latest
    if: "!contains(github.event.head_commit.message, '--skip-ci')"
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 16
      - name: Setup pnpm
        uses: pnpm/action-setup@v2.2.2
        with:
          version: 7.5.1
      - name: Use Package Cache
        uses: actions/cache@v3
        id: pnpm-cache
        with:
          path: "**/node_modules"
          key: ${{ runner.os }}-modules-${{ hashFiles('**/pnpm-lock.yaml') }}
      - if: steps.pnpm-cache.outputs.cache-hit == 'true'
        run: echo 'pnpm cache hit!'
      - if: steps.pnpm-cache.outputs.cache-hit != 'true'
        name: Install dependencies
        run: echo 'pnpm cache missed!' && pnpm install --frozen-lockfile
      - name: Build App
        run: pnpm build
      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-output # ë¹Œë“œ ê²°ê³¼ë¬¼ì— ì´ë¦„ì„ ë¶€ì—¬í•˜ì—¬ ì €ì¥
          path: ./${{ secrets.BUILD_DIR }} # ì—…ë¡œë“œí•  ê²°ê³¼ë¬¼ path
          if-no-files-found: error

  unit:
    timeout-minutes: 3
    runs-on: ubuntu-latest # self-hosted || ubuntu-latest
    if: "!contains(github.event.head_commit.message, '--skip-ci')"
    needs: build
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 16
      - name: Setup pnpm
        uses: pnpm/action-setup@v2.2.2
        with:
          version: 7.5.1
      # ì´ì „ì— ì—…ë¡œë“œ í–ˆë˜ ë¹Œë“œ ê²°ê³¼ë¬¼ì„ ë‹¤ìš´ë¡œë“œ
      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-output
          # ì•„í‹°íŒ©íŠ¸ë¥¼ ì–´ëŠ ìœ„ì¹˜ì— ë‘˜ ê²ƒì¸ì§€ ì„¤ì •
          path: ./${{ secrets.BUILD_DIR }}
      - name: Use Package Cache
        uses: actions/cache@v3
        id: pnpm-cache
        with:
          path: "**/node_modules"
          key: ${{ runner.os }}-modules-${{ hashFiles('**/pnpm-lock.yaml') }}
      - name: Run Unit tests
        run: pnpm test

  e2e:
    timeout-minutes: 3
    runs-on: ubuntu-latest # self-hosted || ubuntu-latest
    if: "!contains(github.event.head_commit.message, '--skip-ci')"
    needs: build
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 16
      - name: Setup pnpm
        uses: pnpm/action-setup@v2.2.2
        with:
          version: 7.5.1
      # ì´ì „ì— ì—…ë¡œë“œ í–ˆë˜ ë¹Œë“œ ê²°ê³¼ë¬¼ì„ ë‹¤ìš´ë¡œë“œ
      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-output
          # ì•„í‹°íŒ©íŠ¸ë¥¼ ì–´ëŠ ìœ„ì¹˜ì— ë‘˜ ê²ƒì¸ì§€ ì„¤ì •
          path: ./${{ secrets.BUILD_DIR }}
      - name: Use Package Cache
        uses: actions/cache@v3
        id: pnpm-cache
        with:
          path: "**/node_modules"
          key: ${{ runner.os }}-modules-${{ hashFiles('**/pnpm-lock.yaml') }}
      - name: Run E2E tests
        run: pnpm test:e2e
```

<ì°¸ê³  ìë£Œ>

- [Testing - Nest.js](https://docs.nestjs.com/fundamentals/testing)
- [NestJSì—ì„œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‘ì„±í•˜ê¸°](https://jhyeok.com/nestjs-unit-test/)
- [nestJS / 'cannot find module' when test](https://velog.io/@flobeeee/nestJS-cannot-find-module-when-test)
- [Nest.js ì˜ ìœ ë‹› í…ŒìŠ¤íŠ¸(Unit test)](https://dailybook-with.tistory.com/entry/Nestjs-%EC%9D%98-%EC%9C%A0%EB%8B%9B-%ED%85%8C%EC%8A%A4%ED%8A%B8Unit-test)
- [Nest JS JEST(Unit Test)](https://velog.io/@baik9261/Nest-JS-JESTUnit-Test)
- [Test process.env with Jest](https://stackoverflow.com/questions/48033841/test-process-env-with-jest)
- [Nest.js - unit testing, e2e testing (feat. jest)](https://inuplace.tistory.com/734)
- [[Jest] jest.fn(), jest.spyOn() í•¨ìˆ˜ ëª¨í‚¹](https://www.daleseo.com/jest-fn-spy-on/)
- [[JEST] ğŸ“š ëª¨í‚¹ Mocking ì •ë¦¬ (jest.fn / jest.mock /jest.spyOn)](https://inpa.tistory.com/entry/JEST-%F0%9F%93%9A-%EB%AA%A8%ED%82%B9-mocking-jestfn-jestspyOn)
- [[NodeJS] Jest mockì„ ì‚¬ìš©í•œ ë‹¨ìœ„í…ŒìŠ¤íŠ¸](https://llshl.tistory.com/42)
- [Configuring Jest - Jest](https://jestjs.io/docs/configuration)
- [Is there anyway to extend a jest configuration file?](https://stackoverflow.com/questions/40726702/is-there-anyway-to-extend-a-jest-configuration-file)

---

1. Naming convention

- í”„ë¡œì íŠ¸ ì´ˆê¸° ì„¤ì •í•˜ë©´ì„œ ê¸°ì¡´ì— ì¢€ í—·ê°ˆë ¸ë˜ Naming Conventionì„ í™•ì‹¤í•˜ê²Œ í•´ë³´ê¸°ë¡œ í•¨

<ì°¸ê³  ìë£Œ>

- [Naming Conventions - api.gov.au](https://api.gov.au/sections/naming-conventions.html)
- [Database, Table and Column Naming Conventions](https://www.geeksforgeeks.org/database-table-and-column-naming-conventions/)
- [REST Resource Naming Guide](https://restfulapi.net/resource-naming/)
- [Learn SQL: Naming Conventions](https://www.sqlshack.com/learn-sql-naming-conventions/)
- [How I Write SQL, Part 1: Naming Conventions](https://launchbylunch.com/posts/2014/Feb/16/sql-naming-conventions/)
