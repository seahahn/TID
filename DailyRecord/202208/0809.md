# 20220809

1. Next.js 페이지의 displayName 활용하기 (feat. NextAuth)

- 앱 전체에 세션을 적용하기 위해 \_app에 세션 관련 코드를 추가하였음
- 처음에는 세션이 들어와서 사용자 정보가 있으면 페이지 랜더링을 하고, 아니면 안 하는 식으로 만들었음

  ```ts
  // _app.tsx
  function PageWithRedux({ Component, pageProps: { session, ...pageProps } }: AppProps) {
    return (
      <SessionProvider session={session}>
        <AuthSession>
          <Component {...pageProps} />
        </AuthSession>
      </SessionProvider>
    );
  }

  /**
   * 앱 전체에서 사용자 세션 유지를 위해서 추가함
   * * SessionProvider 안에 있어야 하기에 이런 형태로 구현함
   */
  function AuthSession({ children }: { children: ReactElement<any, any> }) {
    const { data: authSession, status } = useSession();
    const { isSignedIn } = useAppSelector((state) => state.user); // 세션이 들어온 후 사용자 정보 저장이 되었는지를 알려주는 변수

    useEffect(() => {
      // 로그인 처리 완료되면 토큰 및 사용자 ID를 세션에 저장함
      status === "authenticated" && handleSignIn(authSession);
    }, [authSession]);

    return isSignedIn ? <>{children}</> : <>loading...</>; // 문제의 원인
  }

  function MyApp(props: AppProps) {
    return (
      <Provider store={store}>
        <PageWithRedux {...props} />
      </Provider>
    );
  }

  MyApp.getInitialProps = async (appContext: AppContext) => {
    const appProps = await App.getInitialProps(appContext);
    return {
      ...appProps,
    };
  };

  export default MyApp;
  ```

- 이때 세션이 들어올 필요가 없는 페이지(ex. 로그인)까지 출력을 안 하는 문제가 발생함
- 따라서 세션이 필요한 페이지와 필요 없는 페이지를 구분할 필요가 있었음
- 이를 위해 각 페이지의 displayName을 가져오고자 함
- 문제는 AuthSession에서 props로 받은 children에 displayName이 있어야 할텐데 보이질 않음
- 원인을 살펴보니 페이지에 React.memo를 적용했기 때문이었음
- memo를 해제하고 아래와 같이 접근하니 페이지의 displayName을 가져올 수 있었음
  ```ts
  consolelog("AuthSession", children.type.name);
  ```
- 이를 바탕으로 코드를 재구성하였고, 최종적으로 아래와 같은 형태를 통해 원하는 바를 구현하였음

  ```ts
  // _app.tsx
  function PageWithRedux({ Component, pageProps: { session, ...pageProps } }: AppProps) {
    return (
      <SessionProvider session={session}>
        <DefaultSeo {...SEO} />
        <AuthSession>
          <Component {...pageProps} />
        </AuthSession>
      </SessionProvider>
    );
  }

  function AuthSession({ children }: { children: ReactElement<any, any> }) {
    const { data: authSession, status } = useSession();
    const { isSignedIn } = useAppSelector((state) => state.user);

    // 세션이 필요없는 페이지 목록
    const noNeedSessionPages = ["Home", "Welcome", "Login", "Register", "RegisterSuccess", "ResetPassword", "SendTempPwSuccess"];

    useEffect(() => {
      // 로그인 처리 완료되면 토큰 및 사용자 ID를 세션에 저장함
      status === "authenticated" && handleSignIn(authSession);
    }, [authSession]);

    // 아래와 같이 세션이 있거나 세션이 필요없는 경우에만 페이지가 출력되도록 함
    return isSignedIn || noNeedSessionPages.includes(children.type.name) ? (
      <>{children}</>
    ) : (
      <div className="flex justify-center items-center absolute inset-0 backdrop-blur-sm">
        <LoadingSpinner sizeClassNames="w-20 h-20" />
      </div>
    );
  }

  function MyApp(props: AppProps) {
    return (
      <Provider store={store}>
        <PageWithRedux {...props} />
      </Provider>
    );
  }

  MyApp.getInitialProps = async (appContext: AppContext) => {
    const appProps = await App.getInitialProps(appContext);
    return {
      ...appProps,
    };
  };

  export default MyApp;
  ```

<참고 자료>

- [리액트의 렌더링은 어떻게 일어나는가?](https://yceffort.kr/2022/04/deep-dive-in-react-rendering)
- [7분만에 Next Auth 알아보기](https://blog.toycrane.xyz/7%EB%B6%84%EB%A7%8C%EC%97%90-next-auth-%EC%95%8C%EC%95%84%EB%B3%B4%EA%B8%B0-d4432ff97158)

---

2.
